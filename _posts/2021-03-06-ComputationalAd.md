---
layout: post
title: "《计算广告》读书笔记"
date: 2021-03-06
description: "《计算广告》读书笔记"
tags: 算法
---

<h1>一. 在线广告综述</h1>

<h2>1.1 广告的定义和目的</h2>

<h3>广告定义</h3>

&emsp;&emsp;**广告是由已确定的出资人通过各种媒介进行的有关产品(商品、服务和观点)的，通常是有偿的、有组织的、综合的、劝服性的非人员的信息传播活动。**  
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;--<<当代广告学>>                                                            


[comment]: <> (这一定义中有两个关键点。首先，它指出了广告活动的两个主动参与方——出资人 (sponsor)和媒体(medium)。在数字广告这样更加复杂的市场结构中，我们可以用一般性的术语来描述它们:需求方(demand)和供给方(supply)。这里的需求方可以是广告主(advertiser)、代表广告主利益的代理商(agency);这里的供给方可以是媒体，也可以是其他技术形态的变现平台。 另外，要特别注意的是，广告还有一个被动的参与方，即受众(audience)。)

-  参与方
    - 需求方: 可以是广告主, 代表广告主利益的代理商或者其他技术形态的采买方；
    - 供给方: 可以是媒体，也可以是其他技术形态的变现平台；
    - 受众
    
出资人、媒体和受众这三者的利益博弈关系是广告活动永远的主线，这一主线将贯穿于商业和产品形态的整个演化过程。

[comment]: <> (另外，该定义还阐明了广告必须是有偿的、非人员的信息传播活动。这两点限制，前者使得广告的目标变得明确，后者使得这一目标可以采用计算的方式来优化，而这些都是计算广告产生的基础。)

<h3>广告目的</h3>

  - 品牌广告(Brand Awareness): 希望借助媒体的力量来快速接触大量用户,以达到宣传品牌形象,提升中长期购买率与利润空间的目的。
  - 效果广告(Direct Response): 希望能利用广告手段马上带来大量的购买行为。

[comment]: <>(在传统媒体时代，供给方与需求方在市场地位上有相当的距离，不论你运营的是电视台、机场或杂志，都与大多数广告主需要的转化行为之间有相当大的差距。因此，这一阶段广告的目的是希望借助媒体的力量来快速接触大量用户，以达到宣传品牌形象、提升中长期购买率与利润空间的目的。这种目的的广告称为品牌广告(brand awareness)。当然，也有许多广告商希望能利用广告手段马上带来大量的购买或其他转化行为，这种目的的广告称为直接效果广告(direct response)，有时也简称为效果广告)

**广告主通过媒体达到低成本的用户接触。**

<p>&emsp;&emsp;广告的低成本, 是与那些"人员"的信息活动传播相对比的, 即相比于那些由市场和销售人员完成的劝服活动, 广告搭媒体流量的便车理应更加有效。</p>

<h2>1.2 在线广告类型</h2>

    - 条幅广告(Banner Ad): 嵌入在页面中相对固定位置的图片,与内容一样需要占据固定的版面。
    
    - 文字链广告(Textual Ad): 这种广告的素材形式是一段链接到广告主落地页的文字,在搜索广告中为主流形式,同时在媒体广告中也被广泛采用。
    
    - 富媒体广告(Rich Media Ad): 这类广告往往是利用视觉冲击力较强的表现形式,在不占用固定版面位置的情况下,向用户侵入式地投送广告素材。
      
    - 视频广告(Video Ad): 视频广告有两种最主要的形式:在视频内容播放之前的前插片广告,以及视频播放暂停时的广告。
    
    - 社交广告(Social Ad): 社交广告中最典型的形式,是插入在社交网络信息流中的广告,这种方式最早见于Twitter,产品称为“Promoted Tweets”。
    
    - 移动设备广告(Mobile Ad): 严格来说, 移动互联网上的广告与桌面电脑上的广告没有本质区别.
    
    - 邮件营销广告(Email Direct Marketing, EDM): EDM是一种主动的广告形式,它不需要等到用户接触的机会产生时才被动地提供广告,而是可以随时向认为合适的用户发送推广信息。
    
    - 团购。本质上是一种按照效果付费的泛广告产品，其特殊性在于广告主除了付推广费用外，还向用户让利以获得转化。团购推广的主要广告主是一些本地化的店铺，主要目的是为了获得新客户。
    
    - 游戏联运。游戏联运根据用户的最终游戏内消费在推广渠道和游戏开发商之间分成的商业产品，这仍然是一种按效果付费的泛广告产品。
    
    - 返利购买。返利购买是电商行业常见的一种推广模式，它与团购有些类似，也是采用折扣或积分的方式激励用户购买。

<h2>1.3 在线广告简史</h2>

    - 展示广告/合约式广告、CPT
    
    - 定向广告/担保式投放、CPM
    
        - 难点：在满足各合约目标受众量要求的同时尽可能为所有广告商分配到质更好的流量。
        - 一是如何有效地将流量分配到各个合约互相交叉的人群覆盖上;
        - 二是要在在线的环境下实时地完成每一次展示决策。
        
    - 竞价广告
    
        - 供给方只向广告主保证单位流量的成本,不再以合约的方式给出量的保证。对每一次展示,都基本按照收益最高的原则来决策。
        
    - 广告网络
    
        - 基于竞价机制和精准人群定向这两个核心功能,在线广告分化出了广告网络(ADN)这种新的市场形态。
          它批量地运营媒体的广告位资源，按照人群或上下文标签售卖给需求方，并用竞价的方式决定流量分配。
        - 使得大量中小互联网媒体有了切实可行的变现手段。
        - 面向多个ADN或媒体按人群一站式采买广告并优化投入产出比的需求方产品，称之为交易终端(Trading Desk, TD)。

    - 实时竞价
        - 通过实时竞价的方式，按照定制化的人群标签购买广告，这样的产品就是需求方平台(DSP)。
        - 聚合各媒体的剩余流量并采用实时竞价方式为他们变现的产品形态 ——广告交易平台(ADX)。
        - 基于DSP的广告采买非常类似于股票市场上的程序交易，这样的广告采买方式也叫做程序化交易(programmatic trade)。
  
[comment]: <> (由于只能在ADN定义好的定向标签组合上预先指定出价，而不能控制每一次展示的出价，因此市场看起来像一个黑盒子，需求方只能靠选择合适的标签组合以及阶段性调整出价来间接控制效果。这种面向多个ADN或媒体按人群一站式采买广告并优化投入产出比的需求方产品，我们称为交易终端(Trading Desk, TD)。)
[comment]: <> (在 ADN 中，核心的竞价逻辑是封闭的，这不能满足需求方越来越明确的利益要求。定制化需求催生了一种开放的竞价逻辑，让需求方按自己的人群定义来挑选流量，这就是实时竞价(Real Time Bidding, RTB)。它是将拍卖的过程由广告主预先出价，变成每次展示时实时出价。)

&emsp;&emsp;**在在线广告发展的历史上，定向技术和交易形式的进化是一条主线**。核心驱动力是让越来越多的数据源为广告决策提供支持，从而提升广告效果。另一主线是将内容与广告以某种方式统一决策或排序。



<h1>二、计算广告基础</h1>

&emsp;&emsp;可衡量的效果以及相应的计算优化是计算广告区别于线下广告的主要特点。

<h2>2.1 广告有效性原理</h2>

&emsp;&emsp;广告效果产生的三个阶段：

![广告效果产生过程示意](https://pic2.zhimg.com/80/v2-0dffeab1e5b6c86ca06908bf5de1a95d_1440w.jpeg)
  
    - 曝光(Exposure)阶段: 这一阶段指的是广告物理上展现出来的过程。此阶段的有效性往往与广告位的物理属性有关,并没有太多可以通过技术优化的空间。实际的广告实践中,曝光的有效性对最终结果的影响往往远远高于其他技术性因素。
    
    - 关注(Attention)阶段:这一阶段指的是受众从物理上接触到广告到意识上注意到它的过程。那么如何使得关注阶段的效率提高呢?我们介绍几个重要的原则:
    
        1. 尽量不要打断用户的任务。
        
        2. 明确向用户推送此广告的目的。
        
        3. 内容符合用户的兴趣或需求,这是受众定向的原理基础。
      
    - 理解(Comprehension)阶段:受众意识到了广告的存在,并不意味着他一定能够理解广告传达的信息。理解阶段有哪些原则呢?
    
        1. 广告内容要在用户能理解的具体兴趣范围内,这就说明了真正精准的受众定向有多么必要。
        
        2. 要注意设定与关注程度相匹配的理解门槛。
        
            - 电视广告中,可以用有一定情节的短故事来宣传品牌;
            - 在路牌广告中,创意制作原则是将若干主要市场诉求都表达出来;
            - 而对于互联网广告,由于用户的关注程度非常低,我们应该集中强调一个主要诉求以吸引用户的注意力。
            
    - 接受(Acceptance)阶段:受众理解了广告传达的信息,并不一定表示他认可这些信息。
    
        1. 广告的上下文环境对于广告的接受程度也有着很大的影响, 同一个品牌广告出现在某游戏社区上和门户网站首页上,用户会倾向于认为后者更具说服力,这也就是优质媒体的品牌价值。
        
        2. 在定向广告越来越普遍的今天,如何让合适的广告出现在合适的媒体上,即广告安全(Ad Safety)的问题,正在引起大家越来越多的关注。
      
    - 保持(Retention)阶段:对于不仅仅追求短期转化的广告商,当然希望广告传达的信息给用户留下长久的记忆,以影响他长时间的选择。
    
    - 决策(Decision)阶段:成功广告的最终作用是带来用户的转化行为,虽然这一阶段已经离开了广告的业务范围,但好的广告还是能够为转化率的提高做好铺垫。

<h2>2.2 互联网广告的技术特点</h2>

    - 技术和计算导向。数字媒体的特点使在线广告可以进行精细的受众定向,技术又使得广告决策和交易朝着计算驱动的方向发展。
      除了受众定向,由于在线广告中独特拍卖性质的市场的存在,对于广告效果精确的预估和优化能力也是非常重要的。
    
    - 效果的可衡量性。可以以展示和点击日志的形式直接记录广告效果，并利用这些日志优化广告效果, 这同样是计算广告非常重要的方法论。
    
    - 创意和投放方式的标准化。标准化的驱动力来自于受众定向与程序购买。既然需求方关心的是人群而非广告位,创意尺寸的统一化与一些关键接口的标准化非常关键。
    
    - 媒体概念的多样化。随着Web 2.0的普及,赋予了更多交互功能的互联网媒体与线下媒体大有不同。随着交互功能的不同,这些媒体与转化行为的距离也就不同。
    
        - 对在线购物行业而言,门户网站、垂直网站、搜索引擎、电商网站、返利网,在转化链条上一个比一个更靠近购买行为。
        
        - 越接近需求方的媒体上的广告,其带来的流量一定可以达到越高的ROI,不过离“引导潜在用户”这样的广告目的也就越远。
        
        - 因此我们在从需求方看在线广告时,应该注重各种性质媒体的配合关系,并从整合营销的角度去审视和优化整体的效果。
    
    - 数据驱动的投放决策。与工业革命时期机器化的根本驱动力电力相类比,**互联网化的根本驱动力可以认为是数据的深入加工和利用**。

<h2>2.3 计算广告的核心问题</h2>

&emsp;&emsp;计算广告的核心问题,**是为一系列用户与环境的组合,找到最合适的广告投放策略以优化整体的投入产出比**。

广告收入的分解：

    - 点击率(Click Through Rate, CTR)：广告点击与广告展现的比率；
    - 到达率：落地页(landing page)成功打开次数与点击次数的比例。注：点击行为成功以后，将会打开广告主的落地页；
    - 转化率(Conversion Rate, CVR)：转化次数与到达次数的比例。注：用户从落地页开始，进一步完成下单等操作，称为转化；

投入产出比的数学表述如下：

$$ max \sum_{i=1}^{i=T}(r(a_{i},u_{i},c_{i}) - q(a_{i},u_{i},c_{i})) $$

其中，a、u、c 三个变量，分别代表广告、用户与环境，即广告活动的三个参与主体。$$r$$为收入函数，$$q$$为成本函数。
对一个广告市场中具体的产品形态而言,我们往往能够主动优化的是收入而非成本的部分。对于收入的的建模：

$$eCPM = r(a,u,c) = CTR(a,u,c) * v(a,u,c)$$
    
其中，$$CTR(a,u,c)$$表示点击率,用$$ν(a,u,c)$$表示点击价值，即单次点击为广告产品带来的收益。这两部分的乘积，定量地表示了某次或若干次展示的期望收益。

&emsp;&emsp;由于广告市场的协作关系复杂，并非每个广告产品都可以对 eCPM 中的两个步骤做出较准确的估计。根据eCPM的分解决定哪部分由谁来估计是广告市场各种计费模式产生的根本原因，也是广告市场中商业逻辑与产品架构衔接的关键一环。

<h2>2.4 在线广告计费方式</h2>

在线广告结算方式比较

![各种计费方式对比](https://pic2.zhimg.com/80/v2-f74ce7bc304d43ae7cbdbd5bd7cbebdd_1440w.jpg)

结算方式说明:

  - CPM(Cost per Mille)计费: 按照千次展示计费。供给方与需求方约定好千次展示的计费标准（偏向品牌广告）；
    
  - CPC(Cost per Click)计费：按点击结算。供给方估计点击率，而需求方则估计点击价值（偏向效果广告）；
    
  - CPS(Cost per Sale)/CPA(Cost per Action)/ROI计费,即按照销售订单数、转化行为数或投入产出比来计费,而这些都是按照转化付费的一些变种。需求方只按照最后的转化收益来结算，从而在最大程度上规避了风险。（偏向效果广告）
    
  - CPT(Cost per Time)计费,这是针对大品牌广告主特定的广告活动,将某个广告位以独占式方式交给某广告主,并按独占的时间段收取费用的方式。
    
&emsp;&emsp;既然广告有计费的需求，也就同时产生了效果监测的需求。在 CPM 类品牌广告中，由于曝光在媒体上产生，广告主往往会委托第三方的广告监测公司对曝光量、点击量等指标作技术核实，并以此作为结算的依据。

<h2>2.5 在线广告技术栈</h2>

    - 标签挖掘: 即对a(ad), u(user), c(context) 打标签以方便挖掘的技术,对应产生了受众定向问题;
    
    - CTR: 如果不考虑全局最优,则主要依靠eCPM估计,特别是CTR预测来完成每一次展示时的局部优化;
    
    - 在线分配: 如果考虑到量的限制和投放时即时决策的要求,就产生了在线分配的问题;
    
    - 定价策略: 为了在多方博弈的市场中达到动态平衡时的收益最大化,则需要对定价策略做深入研究;
    
    - RL: 为了更全面地采样整个(a, u, c) 的空间以便更准确地估计点击率,需要用到强化学习(Reinforcement Learning)中的探索与利用(Explore and Exploit, E&E)算法
    
    - 推荐：而在DSP快速发展的今天,推荐算法也被广泛使用在个性化重定向当中。

<h1>三. 合约广告&竞价广告</h1>

<center><img src="http://image.woshipm.com/wp-files/2020/03/50OHKjnXN5uSEpzpHkVU.jpeg" width="50%" height="50%" alt="合约广告产品" title="合约广告产品"></center>

<h2>3.1 合约广告</h2>

&emsp;&emsp;合约式广告的重点是按CPM计费的展示量合约广告，售卖的对象已经由“广告位”进化到了“广告位+人群”。从供给方产品和技术的复杂程度来看，CPM合约甚至比以后的竞价系统更加复杂，其复杂性主要来源于多个合约对投放系统提出的量的约束。[图论在计算广告中的应用](https://zhuanlan.zhihu.com/p/23562855)

- 合约广告产品有两种售卖方式：广告位合约和展示量合约。
    - 广告位合约：在一些强曝光属性的广告位上采用这种独占式的广告投放，往往可以有效地给用户带来品牌冲击；而在其他一些横幅位置长期独占式的购买有利于形成“橱窗效应”，塑造不断攀升的品牌价值和转化效果。
    - 展示量合约：实践中的展示量合约往往是以一些曝光率很大的广告位为基础，再切分人群售卖，最典型的例子是视频网站的贴片位置或者门户网站首页的广告位。这种模式的出现实际上已经反映了互联网广告计算驱动的本质：分析得到用户和上下文的属性，并由服务端根据这些属性及广告库情况动态决定广告候选。
      相对于广告位合约来说更需要一些技术手段的支持，比如受众定向、流量预测、流量在线分配，担保式投放等。

- 受众定向技术分类
    - 用户标签，即t(u)，以用户历史行为数据为依据，为用户打上的标签；
    - 上下文标签，即t(c)，根据用户当前的访问行为得到的实时标签；
    - 定制化标签，即t(a,u)，这也是一种用户标签，但必须根据广告主的某些属性或数据来加工；

<img src="https://wdxtub.com/images/read/computer/%E8%AE%A1%E7%AE%97%E5%B9%BF%E5%91%8A-5.jpg" width="40%" height="40%" alt="受众定向技术分类" title="受众定向技术分类" align="middle">

- 受众定向典型方法
    - 地域定向、人口属性定向、频道定向、上下文定向、行为定向、精确位置定向。
    - 标签系统：按照某个分类法(taxonomy)指定一个层次标签体系，其中上层标签是下一层的父节点，在人群覆盖上是包含关系。

- 流量预测
    - 售前指导。需要尽量避免流量的低估或高估
    - 在线流量分配。当一次曝光同时满足两个以上合约要求时，怎样决策将它分配给哪个合约以达到整体满足所有合约的目的。
    - 出价指导。由于在竞价广告中没有了量的保证，广告主往往需要根据自己预计的出价先了解一下可能获得多少流量。
    
- 在线分配
    - 各个合约要求的人群可能大量重叠，如何设计分配策略，使得各个合约都尽可能被满足，可以被简化成一个二部图(bipartite graph)匹配的问题。
    - 我们需要在每一次曝光时实时做出分配决策。在线分配需要根据历史数据和某种策略离线得到一个分配方案，线上则按照此方案执行。
<p>
<img src="https://pic1.zhimg.com/80/v2-f9081e285ff0b39846adfa66a37c90c0_1440w.png" width="50%" height="40%" alt="流量在线分配" title="流量在线分配" align="left">

<img src="https://pic4.zhimg.com/80/v2-a2a1ad9448b07bf12b30136de1a0e8d7_1440w.png" width="20%" height="40%" alt="流量在线分配" title="流量在线分配" align="middle">
</p>

<h3>合约广告存在的问题</h3>

<p>
&emsp;&emsp;随着标签数量的增加，供给节点的数量会以指数速度上升，而每一个供给节点的流量当然也就迅速收缩。当节点的流量过小时，对其进行相对准确的预测就变得相当困难，这时前面的方案就会变得完全不可行。
因此，展示量合约这类广告产品在人群标签非常丰富和精准时时无法有效地运作的，而这正是竞价广告产品的原动力之一。同时，大量精准的标签在合约量的舒服下基本无法售卖。一个广告产品声称自己的标签体系多么复杂，
有多少标签种类，实际上没有太大的实际意义，这些标签的人群规模会更有说服力。
</p>

<h2>3.2 竞价广告</h2>

- 竞价广告产品的主要产品形式是搜索广告和广告网络。

<p>
&emsp;&emsp;竞价交易模式的本质是将量的约束从交易过程中去除，仅仅采用“价高者得”的简单决策方案来投放每一次广告。竞价顺应了定向广告向精细化发展得趋势要求，也为大量无法用合约售卖的剩余流量找到了可能的变现渠道，使得大量中小广告主参与在线广告的可能性和积极性大大增加，也使得在线广告的商业环境与传统广告产生了本质差别。
</p>

<p>&emsp;&emsp;搜索广告在竞价广告乃至整个在线广告中都有着旗舰产品的地位。除了它的变现能力和市场规模方面的优势，更重要的是，一些在计算广告中非常核心的产品策略和技术方案都来源于搜索广告。</p>

<center><img src="http://image.woshipm.com/wp-files/2020/03/BMJykdJMLzYqHqUxYFet.png" width="75%" height="75%" alt="广告市场份额" title="广告市场份额"></center>


- 搜索广告

&emsp;&emsp;搜索广告竞价的标的物是竞价关键词(bid term)，用户输入的查询(query)通过与关键词相匹配来确定是否可以触发该条广告。搜索广告的优化目标：对每次展示的各个候选，根据查询估计其点击率 $$\mu$$ 并乘以广告主出的点击单价得到 eCPM，再按此排序即可。

$$max_{a_1,...,T}\sum_{i=1}^T\{\mu(a_i,c_i)·bid_{CPC}(a_i)\}$$

搜索广告的产品和技术特点有：

    1. 变现能力强，即eCPM远远高于一般的展示广告。关键原因在于用户主动输入的查询直接反映了用户的意图。
    2. 搜索广告的受众定向目标，即是上下文的搜索查询。由于搜索词非常强地表征着用户的意图，搜索广告可以进行非常精准的定向。
       在这个情况下，根据用户历史行为得到的兴趣标签的重要性大打折扣，搜索广告里的eCPM由一般情形下的r(a,u,c)退化
       成r(a,c)(即不再考虑user这个维度)；
    3. 搜索广告的展示形式与自然结果的展示形式非常接近，往往仅仅在底色和文字链接中有不太引人注目的提示。

- 产品策略

<center><img src="https://coladrill.github.io/img/post/20190113/2.jpg" width="80%" height="80%" alt="搜索产品形式" title="搜索产品形式"></center>

    - 查询扩展：精确匹配；短语匹配；广泛匹配；否定匹配;
    - 检索与排序：将候选广告根据eCPM排序（核心流程）;
    - 广告放置：设定北区和东区的进入条件：广告相关性和RPM。确定一条广告能否进入北区要考虑两个关键因素：一是该广告相关性是否足够；二是该广告的RPM（Revenue Per Mile 千次展示收入）是否足够。前者是为了确保用户体验，后者是为了高效地利用展示位置。
    而东区在合理和可解释的范围内可以增加一点相关性要求稍低的泛化内容，这部分的列表和排序可以按照竞价广告的逻辑来运营，可以为搜索引擎提供一些离决策稍远、以接触潜在用户为目的的广告。
    比如搜索宝马，宝马的用户可能不一定了解路虎，但是在此处看到以后或许会点击了解并对其发生兴趣。当然，这样的产品绝对不能在北区展示，因为那样会引起用户对结果相关性的质疑。

<center><img src="http://image.woshipm.com/wp-files/2020/03/Wiq2Pkydck4yqMhoLe0X.png" width="50%" height="50%" alt="搜索广告示例" title="搜索广告示例"></center>

[comment]: <> (确定一条广告能否进入北区要考虑两个关键因素：一是该广告相关性是否足够；二是该广告的RPM（Revenue Per Mile 千次展示收入）是否足够。前者是为了确保用户体验，后者是为了高效地利用展示位置。而东区在合理和可解释的范围内可以增加一点相关性要求稍低的泛化内容，这部分的列表和排序可以按照竞价广告的逻辑来运营，可以为搜索引擎提供一些离决策稍远、以接触潜在用户为目的的广告。比如搜索宝马，宝马的用户可能不一定了解路虎，但是在此处看到以后或许会点击了解并对其发生兴趣。当然，这样的产品绝对不能在北区展示，因为那样会引起用户对结果相关性的质疑。)

- 位置拍卖与机制设计
<center><img src="https://coladrill.github.io/img/post/20190113/3.png" width="50%" height="50%" alt="位置拍卖与机制设计" title="位置拍卖与机制设计"></center>

&emsp;&emsp;如图所示，假设有一组广告位可以被占用，将这些广告位按照其经验价值排名，分别记为s=1,2,···,$$S$$。在某次广告请求中，有一组广告a=1,2,···,$$A$$出价参与拍卖，每个广告的出价记为$$b_{a}$$，系统将前S个高出价的广告依次放到前面排序好的S个广告位上，这样的问题称为**位置拍卖**。

&emsp;&emsp;当某个广告a被放在s位置上时，其**期望收益**即eCPM为$$r_{sa} = u_{s}*v_{a}$$。这里我们作了一些**假设**，比如，点击率$$u$$仅与位置$$s$$有关，而点击价值$$v$$仅与广告$$a$$有关，这些假设在搜索广告给定某具体关键词的情形下可以说基本合理，对于展示广告的情形虽然非常近似，但并不太影响对竞价问题宏观市场的讨论。

- 定价策略

&emsp;&emsp;在定价问题上，从整个市场的角度来看，重点需要研究的是市场处于**稳定状态**下的收益和其他特性。稳定指的是整个竞价系统处于**纳什均衡状态**，也即每个广告主都通过出价得到了最符合自己利益的位置。

<p>&emsp;&emsp;对某一次位置竞价来说，其对称纳什均衡状态可以表示为下式：</p>

<p><img src="https://coladrill.github.io/img/post/20190113/4.png" alt="" /></p>

<p>在线广告竞价市场最常见的定价策略是GSP（广义第二高价）方案；另外有一种VCG（Vickrey-Clarke-Groves）定价策略。</p>

    - GSP

<p>&emsp;&emsp;其基本思想：指的是在只有一个位置的拍卖中，向赢得该位置的广告主收取其下一位广告主的出价。 </p>

    - VCG

<p>&emsp;&emsp;其基本思想是：对于赢得了某个位置的广告主，其所付出的成本应该等于他占据这个位置给其他市场参与者带来的价值损害。在这一原则下，VCG的定价策略可以表示为公式：</p>

<p><img src="https://coladrill.github.io/img/post/20190113/6.png" alt="" /></p>

- MRP

<p>为了控制广告的质量和保持一定的出售单价，竞价广告市场往往要设置一个赢得拍卖位置的最低价格，称为市场保留价(Market Reserve Price, MRP)，俗称“起价”或“底价”。确定MRP是竞价广告重要的产品策略，MRP定得过低或过高都不利于整个市场的收益最大化。</p>

- 价格挤压

&emsp;&emsp;能够根据市场情况更主动地影响竞价体系向着需要的方向发展。在CPC结算的广告产品中，eCPM可以表示成点击率和出价的乘积，即$$r=µ·ν=µ·bid_{CPC}$$ 。但是在竞价的机制设计中，有时会对此公式做一些微调，把它变成下面的形式：$$r=\mu·ν=\mu^{k}·bid_{CPC}$$

其中的κ为一个大于 0 的实数。可以考虑两种极端情况来理解κ的作用：
<ul>
  <li>当κ→∞时，相当于只根据点击率来排序而不考虑出价的作用</li>
  <li>当κ→0时，则相当于只根据出价来排序</li>
</ul>

<p>&emsp;&emsp;随着κ的增大，相当于我们在挤压出价在整个竞价体系中的作用，因此这个因子叫做价格挤压（squashing）因子。</p>

- 竞价广告技术算法
    - 输入:
        - 候选广告ID列表: vector<int> &cands;
        - 候选广告预估CTR列表: vector<vector<float>> &ctrs;
        - 候选广告出价列表: vector<vector<float>> &bids;
        - 市场保留价: float MRP;
        - 价格挤压因子: float squash;
        - 要求的广告条目数: int slotNum;
        
    - 输出:
        - 排序结果: vector<int> &results;
        - 计价结果: vector<vector<float>> &prices;
        
    - 计算流程:
        1. 按照给定的squashing因子调整预估CTR;
        2. 计算调整后的eCPM(跳过出价小于市场保留价的候选);
        3. 将所有候选按照eCPM排序;
        4. 得到各竞价结果并计算定价;

- 定价结果示例

<p><img src="https://coladrill.github.io//img/post/20190113/8.png" alt="" /></p>

<p>&emsp;&emsp;从上表的例子中可以看出，经过GSP的CPC定价并不是降序的，并且存在低于MRP（如第3位的广告）的情形，这时需要将其强制设为MRP；另外，κ会对排序和计价都有明显的影响。</p>

- 广告网络

<p>
&emsp;&emsp;对展示广告而言，合约式的售卖方式必然无法消耗所有的库存，未通过合约售卖的广告流量我们称为剩余流量。广告网络的产品功能是批量聚合各媒体的剩余流量，按照人群或上下文标签的流量切割方式售卖给广告主。竞价广告网络有下面几个关键的产品特点：
    <ol>
        <li>广告网络根据eCPM来决定每次展示分配给哪个广告主;</li>
        <li>由于是按人群售卖，广告网络淡化媒体和广告位的概念。由于淡化了媒体的概念，广告网络中很难拿到品牌溢价高的广告位，一般来说也不适合广告主的品牌类需求;</li>
        <li>从商业角度来看，无需再满足广告主品牌独占的要求，多个品牌可以同时参与同一个人群的竞价。再者财务上采用广告主先充值的方式使得广告网络运营方的现金流状况大为改善。</li>
        <li>广告网络存在CPM、CPC和CPS等不同的结算方式，不过最主流的方式是CPC。某些广告网络也会对一部分合作供给方开放广告库供其自行挑选，广告网络的这种运营模式可以称为联盟（affiliate）模式，比如淘宝联盟。</li>
    </ol>
</p>

<h2>合约广告VS竞价广告</h2>

<p>
    <ol>
        <li>从供给方或广告市场方来看，合约广告和竞价广告的对比可以类比于计划经济和市场经济的区别。合约广告情况下，媒体要要保证量和质。而在竞价广告的情况下，市场只负责制定竞价和收费的规则，广告主量的保证采用市场竞争的方式来完成。</li>
        <li>从需求端来看，合约广告的采买方式对广告主来说缺乏透明性，无法确定媒体确实投放这么多量。不过，预先预定保证量的合约的采买方式这对于品牌性质较强的广告活动来说比较有意义的。在竞价广告中，供给方不再向广告主承诺广告投放量，且交易逻辑由首先确保量的结构变成了首先确保单位成本的结构。</li>
    </ol>
</p>

<h1>四、程序化交易广告</h1>

&emsp;&emsp;随着需求方优化效果的要求进一步加强，广告网络在产品形态上已经无法完全满足需要，而市场的发展方向是向需求方彻底开放。除了允许广告主按照已经定义好的用户划分来购买，还要进一步提供**广告主自行选择流量和在每次展示上独立出价的功能**。这必然要求询价、出价和竞价在展示时进行，这就产生了以实时竞价即 RTB 为核心的程序化交易市场。

&emsp;&emsp;RTB的产生，使得广告市场向着透明的比价平台的方向发展，这样的平台就是广告交易平台 ADX，其主要特征即是用 RTB 的方式实时得到广告候选，并按照其出价简单完成投放决策。与广告交易平台对应的采买方，我们称为需求方平台 DSP。需求方对于流量的选择和控制能力达到了极致，因此其技术和算法的挑战也相当大，而供给方则变成了简单的比较平台。

&emsp;&emsp;出价需求的存在和广告主预算范围内的套利要求DSP具备点击率预测、点击价值估计、流量预测、站外推荐等多方面的运算能力。

&emsp;&emsp;在需求方的利益得到了充分的保证以后，媒体的变现手段也发生了相应的变化。到现在为止，媒体至少有四种常用的广告变现选择：

  1. 担保式投送的合约售卖方式
  2. 自营广告网络
  3. 托管给其他广告网络
  4. 通过 RTB 变现

如何动态地选择这四种模式中变现价值最高的那种，以最大化媒体收益，这是供给方面临的市场需求，因此产生了供给方平台这样的完全优化媒体利益的产品。

RTB 的产生和发展实际上还催生了另外一个更加重要的市场：数据加工和交易市场。作为数据加工与交易的两个关键产品：数据交易平台(data exchange)和数据管理平台 DMP 分别从第三方数据和第一方数据入手，为市场提供了有价值的数据源或数据加工服务。

<h2>4.1 实时竞价</h2>

&emsp;&emsp;定制化用户标签(customized audience segmentation)是在加工人群标签的过程中利用到广告主的数据。用定制化标签指导广告投放是实时竞价的关键产品目标。服务于品牌广告主的 DSP 可以根据市场上采买的各种数据为某个特定的广告主加工特有的人群，完成更加符合其市场策略的人群触及。
实时竞价的接口可以分成两个过程，即预先进行的将 ADX 与 DSP 的用户标识对应起来的 cookie 映射(cookie mapping)过程和线上广告请求时的竞价和投放过程。

  1. Cookie 映射
      - 从广告主网站向 DSP 服务器发起 cookie 映射请求
      - DSP 与 ADX 服务器之间通信完成 cookie 映射
  2. 广告请求(ad call)
      - 用户浏览媒体网站
      - 媒体网站通过 JavaScript 或 SDK 向 ADX 发起广告请求
      - ADX 向各 DSP 传送 URL 和本域名 cookie，发起询价请求。DSP 根据预先做好的 cookie 映射查出对应的己方 cookie，决策是否参与竞价，如果参与，则返回自己的出价。在等待一个固定的时间片后，ADX 选出出价最高的 DSP 返回给媒体网站

实时竞价也带来了一些实际问题：

  1. 每次展示都有 ADX 服务器与多个 DSP 服务器的参与，这使得服务器与带宽成本大大增加。
  2. 在询价过程中，ADX 要等待一个约定好的时间片(一般情况下为 100ms)，这使得用户看到的广告延迟增加，对 CTR 有负面影响。
  3. 原理上DSP可以以极低的出价参与竞价，这样虽然不能获得流量，却可以低成本得到在媒体网站上的用户行为数据，这里存在着潜在的信息泄露风险。


<h1>五. DSP自动报价算法</h1>

<h2>5.1 报价算法对于DSP的意义</h2>

&emsp;&emsp;在广告竞价业务中，自动化报价是不可或缺的一环。业务要求成本和预算是可控的，需要 在这些约束下实现最大化量的目标。在最开始，没有自动化报价算法，我们采用了手动调节， 固定出价的办法，这种方案一方面需要大量的人力，另一方面经常要么成本过低，没能最大化 利用流量，要么成本过高，买的用户不具备性价比。基于这些原因，我们探索并开发了多种自 动化报价算法，解决了满足约束条件下的最大化 DAU 量问题，不仅减少了人力耗费，且有效 利用了流量。

&emsp;&emsp;针对同一广告位，往往会存在多个广告主竞争出价，最终出价高者以一定的成本，赢得广告位并获得展示机会。具体过程如下图所示。
<p><img src="https://static001.infoq.cn/resource/image/76/a7/7650b08d819ed7084d8e49c060dd41a7.png" alt="" /></p>

&emsp;&emsp;互联网广告本质上是一种商业行为，在广告投放中必须要均衡考虑成本与回报。而在参与广告竞价的过程中，广告主出价的高低最终会影响广告获胜率。对于不同的潜在客户群体，采取适当的竞价策略，合理分配预算，在预算有限的条件下，使得企业商业利益最大化。这就要求对不同投放目标设定不同的投放策略及预算，并且需保证实际投放成本贴近预算。当实际投放成本超过预算或低于预算时，都会给广告投放带来负面影响，甚至会导致企业营销计划失败。

&emsp;&emsp;然而在实际的广告投放系统中，会包含诸如广告主端的点击率预估模型、用户价值预估模型、竞价算法，媒体端的 OCPA、OCPC 出价模型，以及多方竞价、二价成交等不可控机制，最终的投放系统十分复杂，影响投放成本的因素过多，造成用户成交价与实际出价并不相等，实际投放成本难以契合广告主在投放初期所制定的预算。

&emsp;&emsp;常用的广告成本控制方法可分为人为干预和算法自动控制两种。顾名思义，人为干预是通过人工实时监控广告投放情况，当发现实际成本低于或超出初期预算时，通过人工调整广告出价或修改人群定向等方式调节投放花费；算法自动控制是指采用相关算法，监控投放成本，并根据异常自动调节广告出价，达到控制成本的目的。

&emsp;&emsp;当前业界使用的相关算法各有特点，在实际应用中，我们综合考虑了算法性能、开发部署成本以及媒体方数据限制，在部分方案中采用了 PID 控制算法。

<h2>5.1 PID控制算法简介</h2>

PID 控制系统结构图:

<p><img src="https://static001.infoq.cn/resource/image/b6/ce/b683bd00e106152e9456948360d570ce.png" alt="" /></p>

&emsp;&emsp;PID 算法包含了比例（Proportion）、积分（Integration）、微分（Differentiation）三个环节，其根据被控对象实际输出与目标值的偏差，按照三个环节进行运算，最终达到稳定系统的目的，其具体公式如下：

式中，Kp——比例增益；Ti——积分时间常数；Td——微分时间常数；err——误差值；

(1) 比例向

&emsp;&emsp;比例项的输出 u(t)与输入 err(t)成正比，直接反映了当前值与目标值得误差信号，偏差一旦产生，立即向相反方向成比例的减小偏差。比例项反应迅速，能快减小偏差，但不能消除静差。

&emsp;&emsp;静差指的是在系统达到稳态的过程中，稳定输入值与目标的差距。仅使用比例项，由于实际输出值与目标值间差距逐渐减小，因而比例项的输出也逐渐减小，只有存在偏差时比例项才能产生输出，当误差为零时，比例项输出也为零，因此在由非稳态逐渐向稳态逼近的过程中，必然会存在静差。

<p><img src="https://static001.infoq.cn/resource/image/d8/69/d8f24e0d905110a9f5033e52d5359f69.png" alt="" /></p>

(2) 积分项

&emsp;&emsp;积分项主要用于消除静差，提高系统的误差度。积分控制作用的存在与偏差 err(t)的存在时间有关，只要系统存在着偏差，积分环节就会不断起作用，对输入偏差进行积分，使控制器的输出及执行器的开度不断变化，产生控制作用以减小偏差。

<p><img src="https://static001.infoq.cn/resource/image/68/fd/685bbd3f1e058780087248d522174bfd.png" alt="" /></p>

（3）微分项

微分环节的作用能反映偏差信号的变化趋势，并能在偏差信号值变得太大之前，在系统中引入一个有效的早期修正信号，从而加快系统的动作速度，减小调节时间。在偏差刚出现或变化的瞬间，不仅根据偏差量做出及时反应，还可以根据偏差量的变化速度提前给出较大的控制作用，将偏差消灭在萌芽状态，这样可以大大减小系统的动态偏差和调节时间，使系统的动态调节品质得以改善。

<h2>5.2 实践案例</h2>

&emsp;&emsp;以信息流广告投放为例，广告主通过采买媒体平台广告位进行广告投放。在广告投放前，综合考虑投放目标以及历史投放经验等，会对广告投放预算成本进行控制，希望能够以预先规划的价格拿到广告位资源（即控制广告成交价）。但由于如前所述的广告投放系统中的出价优化模型以及二价成交机制等，广告主往往不能直接控制成交价，而需通过调整出价等方式间接控制成交价。

&emsp;&emsp;为了能够实现控制成交价的目的，我们实时监控成交价（输出）与预算成本（目标）间关系，并通过 PID 控制算法来动态调整出价，PID 反馈控制环如下图所示：

<p><img src="https://static001.infoq.cn/resource/image/4c/fb/4cd203de3da7ddb1aa9201345f6e26fb.png" alt="" /></p>


<h1>参考博客&书籍</h1>

[【计算广告】我的新赛道](https://wdxtub.com/read/computer/book-007/2019/03/20/)

[图论在计算广告中的应用](https://zhuanlan.zhihu.com/p/23562855)

[计算广告-互联网商业变现的市场与技术](https://github.com/highflykxf/blog_resources/tree/master/books)

[全景揭秘阿里文娱智能算法](https://github.com/highflykxf/blog_resources/tree/master/books)
